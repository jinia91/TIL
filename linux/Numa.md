# NUMA 아키텍처
> None uniform memory architecture : 불균형 메모리 아키텍처

## 공유 메모리 아키텍처와 분산 메모리 아키텍처
- 공유 메모리 아키텍처 : 두개 이상의 프로세서가 메모리를 공유, 모든 프로세서가 동일한 메모리 주소 공간에 엑세스 할수 있음
- 분산 메모리 아키텍처 : 각 프로세서가 자신만의 로컬 메모리를 가지며, 다른 프로세서의 메모리에 직접 엑세스 불가능

일반적인 다중 프로세싱 pc들은 공유 메모리 아키텍처를 택하고 있음. 즉 CPU가 메인 메모리에 있는 모든 데이터에 액세스 가능.
하지만 대형 클러스터나 고성능 컴퓨팅 시ㅡ템에서는 여러개의 체ㅕ나 컴퓨팅 노드가 함께 작동해야 하므로 분산메모리 아키텍처를 사용하는경우가 많음

## NUMA 아키텍처도 공유 메모리 아키텍처
> 두개 이상의 프로세서가 메모리를 공유하지만 모든 메모리가 동일한 액세스 시간을 가지지 않는구조!

- 메모리를 여러 노드로 구분
- 각 프로세서가 로컬 메모리 노드에는 빠르게 액세스가능하나, 원격 메모리 노드에는 더 많은 시간이 소요되게끔 설계되어 메모리 엑세스 시간이 non-uniform 되어있다.
- 즉 물리적으로는 공유메모리 아키텍처이나 논리적으로는 분산 메모리 아키텍처의 형태를 흉내냈다고 볼수 있다

> 일반적으로 서버 개발자가 NUMA 아키텍처가 필요할만큼 대규모 시스템을 만질일이 있을까? 

<img width="1106" alt="스크린샷 2023-05-17 오후 1 24 24" src="https://github.com/jinia91/TIL/assets/85499582/8b30b8ef-5dbf-4d19-9ce3-4f55fea3384a">
- 2017 aws re:invent 에서 나온 numa 튜닝 사례

NUMA 아키텍처의 서버를 사용할때 튜닝이 필요하다면 해당내용을 알아야 튜닝이 가능할것!

- 하지만 일반적인 ec2 머신은 Numa 아키텍처의 특성을 가지진 않음
- x1, r5 메탈 인스턴스같은 유형에만 지원

# 리눅스는 NUMA 아키텍처 support가 기본적으로 가능
> numactl --show

<img width="172" alt="image" src="https://github.com/jinia91/TIL/assets/85499582/e305ea0d-4a9b-486f-a25c-97b6e4da7274">

## 메모리 할당 정책 4가지
- default : 프로세서가 해당하는 노드에서 메모리할당
- bind : 특정 프로세스를 특정 노드에만 할당
- prefered: 선호 노드할당
- interlevered : RR으로 일정하게 할당 

## 실무적으로 필요할때 찾아보자
- membind는 관리가 어려워 실무에서 비추

# numad로 자동으로 메모리 할당관리도 가능

# numa 아키텍처의 최적 성능을 내기위한 튜닝시 인사이트

## 메모리 크기와 프로세스 갯수

|스레드갯수|메모리크기|
|-|-|
|싱글스레드|메모리 노드 하나 크기를 넘지 않음|
|멀티스레드|메모리 노드 하나 크기를 넘지 않음|
|싱글스레드|메모리 노드 하나 크기를 넘음|
|멀티스레드|메모리 노드 하나 크기를 넘음|

사실상 4번짜 케이스가 중요
- 필요 메모리가 노드 하나 크기를 넘기 때문에 메모리의 지역성을 높일 방법을 생각해야함
- 리모트 액세스가 발생
- 일반적으로 이케이스에서는 Interlevered 를 고려
- vm.zone_reclaim_mode = 0

