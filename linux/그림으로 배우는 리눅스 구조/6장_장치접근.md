# 개요
- 프로세스는 장치에 직접 접근하지 못한다
- 커널이 장치에 대신 접근
- 디바이스 파일이라는 특수한 파일을 조작
- 블록장치에 구축한 파일 시스템을 조작
- NIC는 속도 등의 문제로 디바이스 파일을 사용하는 대신에 소켓구조를 사용

# 디바이스 파일
- `/dev/sda`
- `/dev/sdb`
- 프로세스가 디바이스 파일을 조작하면 커널 내부의 디바이스 드라이버라고 부르는 소프트웨어가 사용자 대신에 장치에 접근
- 프로세스는 일반 파일과 똑같은 방식으로 디바이스 파일을 조작하며 복잡한 조작은 ioctl() 시스템 콜을 사용

## 저장 정보
- 파일종류 : 캐릭터 장치 또는 블록 장치
- 디바이스 메이저번호, 마이너번호
- 위치 : /dev/

![image](https://github.com/user-attachments/assets/8e7111da-2e2a-4ab8-9cc3-04088d75a0ed)

- c로 시작하면 캐릭터 장치
- b라면 블록 장치
- 5번째 필드가 메이저
- 6번째 필드가 마이너

  컨터이너 환경이라 직접 블록 장치에 접근하지 않아 b로 시작하는 장치가 없다.
  맥 os 터미널에서 다시 확인해보면
  ![image](https://github.com/user-attachments/assets/1c37d267-bb57-42bd-8179-68d3b84f24fa)

디스크를 블록장치로 취급하고 있음을 확인 가능

## 캐릭터 장치
- 데이터를 문자 단위로 처리하는 장치로서 연속적인 스트림으로 전송하며 대표적으로 키보드 마우스 직렬 포트 등이 있다. 바이트 단위로 순차적으로 접근함
- 따라서 탐색 조작도 불가능
- 예시
  - 키보드
  - 단말
  - 마우스
  ![image](https://github.com/user-attachments/assets/a3a3c408-a23e-42c8-a17d-47dec2af27b4)
  - 원격조작으로 다른 터미널에 접근하기

## 블록 장치
- 파일 읽기 쓰기, 탐색도 가능
- 블록 장치 : 데이터를 블록단위(4kb?) 로 처리하는 장치. 하드 디스크 드라이브 ssd와 같은 저장장치가 이에 해당. 데이터를 블록단위로 읽고 쓰며 고유 주소를 가지고 임의 접근이 가능하다.
  - 메모리
  - 디스크


# 디바이스 드라이버
- 프로세스가 디바이스 파일에 접근할때 동작하는 커널의 기능

## 프로세스 입장에서의 장치조작
1 프로세스가 디바이스 파일을 사용해 디바이스 드라이버에 장치를 조작하고 싶다고 요청
2 CPU가 커널모드로 전환되고 디바이스 드라이버가 레지스터를 사용해서 장치에 요청을 전달
3 장치가 요청에 따라 처리
4 디바이스 드라이버가 장치의 처리 완료를 확인하고 결과 받기
5 CPU가 사용자 모드로 전환되고 프로세스가 디바이스 드라이버 처리 완료를 확인해서 결과 받기

## 메모리 맵 입출력(MMIO)
- 현대적 장치는 메모리 맵 입출력 구조를 사용해서 디바이스 레지스터에 접근
- 커널은 가상 메모리 매핑시 페이지 테이블에 물리 메모리뿐 아니라 장비들의 레지스터도 매핑한다
- 이 레지스터 매핑 가상 메모리를 통해 레지스터에 접근 및 조작
- 디바이스 동작 완료에 대한 처리는 폴링 또는 인터럽트로 수행

## 폴링
- 디바이스 드라이버가 능동적으로 장치에서 처리를 완료했는지 확인
- 장치의 레지스터값이 변경되면 디바이스 드라이버가 폴링하여 체크한다
- 폴링이므로 cpu가 동작해야하기때문에 다른일을 할수 없느 블록킹상태가 된다
- 보통은 폴링을 일정 간격을 두고 쳐서 컨텍스트 스위칭할 여유를 둠

## 인터럽트
- 디바이스 드라이버가 장치에 처리를 요청하고 이후 cpu는 다른 처리 실행
- 장치 처리를 완료하면 인터럽트 방식으로 cpu에게 알림
- cpu는 사전 디바이스 드라이버가 등록한 인터럽트 핸들러 처리를 호출
- 인터럽트 핸들러가 처리 결과를 받기
- 인터럽트가 os의 주요 처리방식이다
- IRQ (인터럽트 요청)을 인터럽트 컨트롤러에 등록하며 핸들러 등록

## 폴링은 언제쓰지?
- 장치 처리가 빠르고 처리 빈도가 높다면 폴링을 쓸만함
- 인터럽트는 기본적인 오버헤드가 있고, 지연도 있기떄문
- 인터럽트를 쓰다가 빈도가 높아지면 폴링으로 전환하는 로직도 존재함

  # 디바이스 파일명관련
  - 같은 종류의 장치 여러개를 연결한 경우 파일명을 조심해서 다뤄야함
  - 디폴트는 특정 패턴(주로 장치 메이저 마이너 번호 조합)으로 /dev/에 기록
  - 만약 재기동시 장비 등록순서가 무작위라면 매번 다른 매핑으로 문제가 생김
  - 영구 장치명을 이용하여 해결할 수 있다
